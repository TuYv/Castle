网上很多文章的观点都是觉得CAP理论就是单纯的三选二，其实这样的观点不能说错，但是也称不上对。本文尝试对CAP理论做出一些解释，以及使用CAP对常见的数据库和NoSQL进行分析。

# 1.CAP

## 1.1 CAP的定义

- **Consistency**：实际上是可线性化，也就是Linearizability，Linearizability具体的定义可以看[这篇文章](https://github.com/LanceZL/Castle/blob/main/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/%E5%8F%AF%E7%BA%BF%E6%80%A7%E5%8C%96.md)。
- **Availability**：non-failing node必须返回结果，对返回结果的正确性和延迟不做要求。
- **Partition tolerance** ：是指网络断开为两个以上的分区的时候, 节点之间会丢失消息。异步网络中，是一个不可避免的事情。



## 1.2 对Availability的分析

CAP的Availability和大家工作中遇到的可用性不太一样，这里要求的是所有没有发生故障(宕机，GC)的节点必须保证能够返回。比如Raft算法在发生分区的时候，只有大部分节点的集群才能向客户端服务，但是小部分节点的集群其实客户端也是可达的，但是小部分节点集群是无法保证返回的。

但是在工作中大家所说的可用性往往是**发生故障时(断电，过载，分区等)系统会不会停机，或者说会停机多长时间。一般用N个9表示。**

所以CAP理论中的可用性更加的极端，在工作中往往不会使用这种可用性来衡量。



## 1.3 对Consistency的分析

CAP中的Consistency虽然翻译叫 *一致性* ，但是实际上更应该说是 *可线性化*，也就是Linearizability。这是对一致性超高的保证，而且**最重要的是可线性化要求的是对单个对象的操作，真实世界里，可能一次查询就包含很多对象。**

更进一步，一致性不只有CAP和BASE理论里所说的可线性化和最终一致性，一致性的级别有很多，常用的就用：因果一致性，RYW一致性，FIFO一致性等等。所以这里的一致性的二元观点在实际情况中也是不适用的。



### 1.4 对Partition tolerance的分析

CAP中的Partition指的是网络分区，多个分区的机器无法互通。但是现实中真的是这样吗？

**现实中很难有一个手段去判定到底是对端故障，还是发生了分区，亦或是延迟。**

我们常常使用中心化的检查服务(etcd, zk)等来判断，但是这些服务都要求配置 一个延迟时间，可能只是网络堵塞了，这时就将对端判定为分区，从而牺牲A和C是非常不明智的。

所以CAP理论最大的缺点是没有引入对延迟的讨论。



## 1.5 对CAP引入对延迟的讨论

延迟和分区的表现是相似的，有时候对于A和C的选择都不是在发生分区的时候发生，而且在延迟的时候发生，**注意延迟意味着性能**：

- 取消延迟过大的操作——降低可用性
- 重试操作——可能带来一致性的损害

所以分区模型更应该用延迟模型来替代：

- 延迟代表分区，延迟越短，进去分区则会越频繁，可能在遇到分区的时候就要做出抉择。
- 放弃强一致来减少系统的高延迟（因为强一致放弃了Termination性质），在就近服务(data locality)上尤其有用。



## 1.6 系统真的是三选二吗



在同一个数据中心内，网络分区往往不是那么容易发生的。我们在项目中假设网络分区的发生，当然按照上面的描述，判断分区很有可能是通过延迟，那么更大可能性是因为机器故障，在这种情况下，就对A和C做出选择是得不偿失的。